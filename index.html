<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Funil de Vendas (Supabase)</title>
    
    <meta name="theme-color" content="#2fc36a">
    
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.png">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.ico">

    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/apple-touch-icon.png">

    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- ESTILOS GERAIS E MELHORIAS DE LAYOUT --- */
        html, body {
            height: 100%;
            overflow: hidden; 
            background-color: #f8fafc; 
        }
        #kanban-board, #list-view, #message-editor-modal-content {
            height: calc(100vh - 73px);
            overflow-y: auto;
        }
        #kanban-board {
            overflow-x: auto;
        }
        @media (max-width: 767px) {
            #kanban-board, #list-view {
                height: calc(100vh - 115px);
            }
             #message-editor-modal-content {
                height: calc(100vh - 60px);
            }
        }
        .kanban-column {
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease-in-out;
        }
        .kanban-cards {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 4px;
            scrollbar-width: none; /* Firefox */
        }
        .kanban-cards::-webkit-scrollbar { 
            display: none; /* Chrome, Safari, and Opera */
        }
        #deal-modal-content, #history-list-container, #task-list-container, #followup-content-container {
            max-height: 75vh;
            overflow-y: auto;
        }
        .tab-badge {
            background-color: #e2e8f0;
            color: #475569;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: 8px;
        }
        .popup-menu {
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .popup-menu.hidden {
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
        }
        .form-input { margin-top: 4px; display: block; width: 100%; border-radius: 0.5rem; border: 1px solid #d4d4d8; padding: 0.5rem 0.75rem; background-color: #fafafa; }
        .form-input:focus { border-color: #16a34a; outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px #a7f3d0; }
        .tab-button { cursor: pointer; padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #737373; }
        .tab-button.active { border-color: #2fc36a; color: #15803d; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .pulse-animation { animation: pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* --- ESTILOS PARA COLUNAS RECOLHIDAS --- */
        .kanban-column.collapsed { 
            width: 56px; 
            cursor: pointer; 
        }
        .kanban-column.collapsed .column-header-expanded, 
        .kanban-column.collapsed .kanban-cards { 
            display: none; 
        }
        .kanban-column.collapsed .column-header-collapsed { 
            display: flex; 
        }
        .kanban-column .column-header-collapsed .vertical-text { 
            writing-mode: vertical-rl; 
            transform: rotate(180deg); 
            white-space: nowrap; 
            padding: 16px 0; 
        }

        /* --- ESTILOS PARA FOLLOW-UP E FILTROS --- */
        .followup-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2fc36a;
        }
        input:checked + .slider:before {
            transform: translateX(18px);
        }
        .filter-btn.active {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        /* --- NOVOS ESTILOS PARA VISÃO DE LISTA --- */
        #list-view-filters .filter-btn.active {
             background-color: #e2e8f0;
             color: #1e293b;
             font-weight: 600;
        }
    </style>
</head>
<body class="font-sans h-full">

    <div id="login-screen" class="flex items-center justify-center h-screen bg-slate-100 p-4">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-xl shadow-md">
            <div class="text-center">
                <h2 class="mt-6 text-3xl font-bold text-gray-900">CRM Funil de Vendas</h2>
                <p class="text-gray-500">Faça login para continuar</p>
            </div>
            <div id="login-error" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
            <form id="login-form" class="space-y-4">
                <div><label for="email" class="text-sm font-medium text-gray-700">Email</label><input id="email" type="email" required class="form-input" placeholder="seu.email@exemplo.com.br"></div>
                <div><label for="password" class="text-sm font-medium text-gray-700">Sua senha</label><input id="password" type="password" required class="form-input" placeholder="••••••••"></div>
                <div><button type="submit" class="w-full px-4 py-2 text-lg font-semibold text-white bg-[#2fc36a] rounded-full hover:bg-[#29a85b] transition-colors">Entrar</button></div>
            </form>
        </div>
    </div>

    <div id="loading-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-100 z-50">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-600 z-10 pulse-animation">Carregando negociações...</h2>
    </div>

    <div id="crm-app" class="hidden h-full flex flex-col">
        <header class="bg-white p-2 sm:p-4 flex flex-wrap gap-2 sm:gap-4 justify-between items-center border-b border-slate-200 flex-shrink-0">
            <div class="flex items-center space-x-3">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">Funil de Vendas</h1>
            </div>
            
            <div class="w-full md:w-auto md:flex-1 flex justify-center px-0 md:px-4 order-3 md:order-2">
                 <div class="flex items-center gap-2 w-full max-w-lg">
                      <div id="filter-container" class="relative flex-shrink-0">
                           <button id="filter-trigger-btn" class="flex items-center justify-center w-full px-3 py-2 border border-gray-300 rounded-full bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                               <span id="filter-btn-text">Tags</span>
                               <i class="fas fa-chevron-down ml-2 text-xs text-gray-500"></i>
                           </button>
                           <div id="filter-popup" class="hidden popup-menu absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                               <div id="filter-options-container" class="py-1"></div>
                           </div>
                      </div>
                      <div class="relative flex-grow">
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                         <input type="search" id="search-input" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full bg-slate-50 focus:bg-white focus:ring-2 focus:ring-green-400 focus:border-green-400" placeholder="Pesquisar por empresa...">
                      </div>
                      <button id="my-deals-filter-btn" title="Filtrar minhas negociações" class="filter-btn flex-shrink-0 w-10 h-10 flex items-center justify-center border border-gray-300 rounded-full bg-white text-gray-700 hover:bg-gray-50 transition-colors">
                          <i class="fas fa-user"></i>
                      </button>
                      <!-- Botões de troca de visualização -->
                      <div id="view-toggle-buttons" class="flex items-center border border-gray-300 rounded-full p-0.5 bg-slate-100">
                          <button id="kanban-view-btn" class="px-3 py-1 rounded-full text-sm font-semibold bg-white shadow" title="Visão Kanban"><i class="fas fa-grip-vertical"></i></button>
                          <button id="list-view-btn" class="px-3 py-1 rounded-full text-sm font-semibold text-gray-500" title="Visão de Lista"><i class="fas fa-list-ul"></i></button>
                      </div>
                 </div>
            </div>

            <div class="flex items-center space-x-2 sm:space-x-4 justify-end order-2 md:order-3">
                 <button id="add-deal-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full flex items-center">
                     <i class="fas fa-plus mr-2"></i> Nova
                 </button>
                 <div id="user-menu-container" class="relative">
                     <button id="user-avatar-btn" class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold text-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 overflow-hidden"></button>
                     <div id="logout-popup" class="hidden popup-menu absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20">
                         <div class="py-1">
                             <div class="px-4 py-2 border-b">
                                 <p id="popup-user-name" class="text-sm font-semibold text-gray-900 truncate"></p>
                                 <p id="popup-user-email" class="text-sm text-gray-500 truncate"></p>
                             </div>
                             <!-- NOVO: Link para editar mensagens (visível apenas para admins) -->
                             <div id="admin-options"></div>
                             <a href="#" id="popup-logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sair</a>
                         </div>
                     </div>
                 </div>
            </div>
        </header>

        <main id="kanban-board" class="flex space-x-2 sm:space-x-4 p-2 sm:p-4 flex-grow"></main>
        
        <!-- Container para a Visão de Lista -->
        <main id="list-view" class="hidden p-2 sm:p-4">
            <div class="max-w-4xl mx-auto">
                <!-- Container de filtros com alinhamento justificado e responsivo -->
                <div class="flex flex-col gap-4 sm:flex-row sm:justify-between sm:items-center mb-4">
                    <div id="list-view-filters" class="flex items-center gap-2 p-1 bg-slate-200 rounded-full w-fit">
                        <button data-filter="all" class="list-filter-btn filter-btn active px-4 py-1 rounded-full text-sm font-medium border border-transparent">Todos</button>
                        <button data-filter="tasks" class="list-filter-btn filter-btn px-4 py-1 rounded-full text-sm font-medium border border-transparent">Tarefas</button>
                        <button data-filter="messages" class="list-filter-btn filter-btn px-4 py-1 rounded-full text-sm font-medium border border-transparent">Mensagens</button>
                    </div>

                    <!-- Filtro de Colunas -->
                    <div id="list-view-column-filter-container" class="relative">
                        <button id="column-filter-trigger-btn" class="flex items-center justify-center w-full px-4 py-2 border border-gray-300 rounded-full bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                            <span id="column-filter-btn-text">Todas as Colunas</span>
                            <i class="fas fa-chevron-down ml-2 text-xs text-gray-500"></i>
                        </button>
                        <div id="column-filter-popup" class="hidden popup-menu absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                            <div id="column-filter-options-container" class="py-1"></div>
                        </div>
                    </div>
                </div>
                <div id="list-view-container" class="space-y-3">
                    <!-- Itens da lista serão inseridos aqui -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Negociação -->
    <div id="deal-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-20">
        <div id="deal-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-4xl flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0"></div>
    </div>
    
    <!-- Modal de Edição de Tarefa -->
    <div id="task-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-30">
        <div id="task-editor-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0"></div>
    </div>

    <!-- NOVO: Modal do Editor de Mensagens -->
    <div id="message-editor-modal" class="fixed inset-0 bg-slate-100 hidden flex flex-col z-30">
        <header class="bg-white p-4 flex justify-between items-center border-b border-slate-200 flex-shrink-0">
            <h2 class="text-2xl font-bold text-gray-800">Editor de Mensagens de Follow-up</h2>
            <button id="close-message-editor-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
        </header>
        <div id="message-editor-modal-content" class="p-4 sm:p-6"></div>
    </div>

    <!-- NOVO: Modal do Formulário de Mensagem -->
    <div id="message-form-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-40">
        <div id="message-form-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <!-- Conteúdo do formulário será injetado aqui -->
        </div>
    </div>


    <!-- Modal de Confirmação de Exclusão -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <h3 class="text-lg font-bold text-gray-900">Confirmar Exclusão</h3>
            <p id="delete-confirm-message" class="text-gray-600 my-4">Tem certeza que deseja excluir? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="px-6 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-full font-semibold">Cancelar</button>
                <button id="confirm-delete-btn" class="px-6 py-2 text-white bg-red-600 hover:bg-red-700 rounded-full font-semibold">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Envio de Follow-up -->
    <div id="send-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <h3 class="text-lg font-bold text-gray-900">Confirmar Envio</h3>
            <p class="text-gray-600 my-4">A mensagem foi aberta no WhatsApp. Você confirma o envio para registrar e avançar para a próxima fase?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-send-btn" class="px-6 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-full font-semibold">Cancelar</button>
                <button id="confirm-send-btn" class="px-6 py-2 text-white bg-green-600 hover:bg-green-700 rounded-full font-semibold">Sim, confirmo</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 z-50"></div>
    <template id="loader-template"><div class="flex items-center justify-center h-full p-8"><i class="fas fa-spinner fa-spin text-4xl text-green-500"></i></div></template>

    <script>
        // --- INÍCIO: CONFIGURAÇÃO DO SUPABASE ---
        const SUPABASE_URL = 'https://ccenxfyqwtfpexltuwrn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZW54Znlxd3RmcGV4bHR1d3JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzE1MTMsImV4cCI6MjA2ODg0NzUxM30.6un31sODuCyd5Dz_pR_kn656k74jjh5CNAfF0YteT7I';
        
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // --- FIM: CONFIGURAÇÃO DO SUPABASE ---

        // --- ELEMENTOS DO DOM E VARIÁVEIS GLOBAIS ---
        const loginScreen = document.getElementById('login-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const crmApp = document.getElementById('crm-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const kanbanBoard = document.getElementById('kanban-board');
        const dealModal = document.getElementById('deal-modal');
        const dealModalContent = document.getElementById('deal-modal-content');
        const searchInput = document.getElementById('search-input');
        const loaderTemplate = document.getElementById('loader-template');
        const toast = document.getElementById('toast');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const sendConfirmModal = document.getElementById('send-confirm-modal');
        const listView = document.getElementById('list-view');
        const listViewContainer = document.getElementById('list-view-container');
        // NOVOS ELEMENTOS
        const messageEditorModal = document.getElementById('message-editor-modal');
        const messageEditorModalContent = document.getElementById('message-editor-modal-content');
        const messageFormModal = document.getElementById('message-form-modal');
        const messageFormContent = document.getElementById('message-form-content');
        
        // NOVO: Adicionado 'empresas' ao estado da aplicação
        let appData = { deals: [], columns: [], users: [], tags: [], deal_tags: [], tasks: [], history: [], followup_messages: [], followup_logs: [], empresas: [] };
        let currentUser = null;
        let activeTagId = null;
        let filterOnlyMyDeals = true;
        let itemToDelete = { type: null, id: null, dealId: null };
        let followupToSend = { dealId: null, etapa: null };
        let currentView = 'kanban';
        let activeListViewFilter = 'all';
        let activeListColumnFilter = null;


        // --- FUNÇÕES DE UTILIDADE ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-2'); }, 3000);
        }

        // --- LÓGICA DE AUTENTICAÇÃO E INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('sf_crm_user');
            if (savedUser) { 
                currentUser = JSON.parse(savedUser); 
                showApp(true); 
            } else { 
                showLogin(); 
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.classList.add('hidden');
            
            try {
                const { data, error } = await dbClient.from('sf_usuarios').select('*').eq('email', email).eq('senha', password).single();
                if (error || !data) throw new Error('Credenciais inválidas.');
                
                currentUser = data;
                localStorage.setItem('sf_crm_user', JSON.stringify(currentUser));
                showApp(true);
            } catch (err) {
                loginError.textContent = err.message;
                loginError.classList.remove('hidden');
            }
        });

        function showApp(isInitialLoad = false) {
            if (isInitialLoad) {
                loginScreen.classList.add('hidden');
                loadingScreen.classList.remove('hidden');
            }
            setupUserMenu();
            initializeApp();
        }

        function showLogin() {
            localStorage.removeItem('sf_crm_user');
            currentUser = null;
            crmApp.classList.add('hidden');
            loadingScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        async function initializeApp() {
            try {
                // NOVO: Adicionado 'empresasRes' ao Promise.all para carregar as novas empresas
                const [dealsRes, columnsRes, usersRes, tagsRes, dealTagsRes, tasksRes, followupMessagesRes, followupLogsRes, empresasRes] = await Promise.all([
                    dbClient.from('sf_negociacoes').select('*'),
                    dbClient.from('sf_colunas').select('*').order('ordem'),
                    dbClient.from('sf_usuarios').select('*'),
                    dbClient.from('sf_tags').select('*'),
                    dbClient.from('sf_negociacao_tags').select('*'),
                    dbClient.from('sf_tarefas').select('*'),
                    dbClient.from('sf_followup_mensagens').select('*'),
                    dbClient.from('log_envios_followup').select('*'),
                    dbClient.from('empresas_prospeccao').select('*').order('nome_empresa') // Carrega as empresas
                ]);

                const results = [dealsRes, columnsRes, usersRes, tagsRes, dealTagsRes, tasksRes, followupMessagesRes, followupLogsRes, empresasRes];
                for (const res of results) { if (res.error) throw res.error; }

                appData = {
                    deals: dealsRes.data,
                    columns: columnsRes.data,
                    users: usersRes.data,
                    tags: tagsRes.data,
                    deal_tags: dealTagsRes.data,
                    tasks: tasksRes.data,
                    followup_messages: followupMessagesRes.data,
                    followup_logs: followupLogsRes.data,
                    empresas: empresasRes.data, // Armazena os dados das empresas
                    history: []
                };
                
                loadingScreen.classList.add('hidden');
                crmApp.classList.remove('hidden');
                
                setupFilters();
                setupListViewFilters(); 
                renderCurrentView();
                setupEventListeners();
                setupRealtimeSubscriptions();
            } catch (error) {
                loadingScreen.classList.add('hidden');
                crmApp.classList.remove('hidden');
                kanbanBoard.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg"><b>Erro ao carregar dados:</b> ${error.message}</div>`;
                console.error("Erro na inicialização:", error);
            }
        }
        
        // --- LÓGICA DE TEMPO REAL (REALTIME) ---
        function setupRealtimeSubscriptions() {
            const channel = dbClient.channel('public-sf-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sf_negociacoes' }, payload => handleRealtimeChange(payload, 'deals', 'id_negocio'))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sf_tarefas' }, payload => handleRealtimeChange(payload, 'tasks', 'id_tarefa'))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sf_negociacao_tags' }, payload => handleRealtimeChange(payload, 'deal_tags', 'id_negocio_fk'))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sf_followup_mensagens' }, payload => handleRealtimeChange(payload, 'followup_messages', 'id_mensagem'))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'empresas_prospeccao' }, payload => handleRealtimeChange(payload, 'empresas', 'id')) // NOVO: Escuta mudanças na tabela de empresas
                .on('postgres_changes', { event: '*', schema: 'public', table: 'log_envios_followup' }, payload => {
                    handleRealtimeChange(payload, 'followup_logs', 'id_log');
                    if (!dealModal.classList.contains('hidden')) {
                        const openDealId = dealModalContent.querySelector('form')?.dataset.dealId;
                        if (openDealId && (payload.new?.id_negocio_fk == openDealId || payload.old?.id_negocio_fk == openDealId)) {
                            showDealModal(openDealId);
                        }
                    }
                })
                .subscribe();
        }

        function handleRealtimeChange(payload, appDataKey, idKey) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            switch (eventType) {
                case 'INSERT':
                    let exists;
                    if (appDataKey === 'deal_tags') {
                        exists = appData.deal_tags.some(dt => dt.id_negocio_fk === newRecord.id_negocio_fk && dt.id_tag_fk === newRecord.id_tag_fk);
                    } else {
                        exists = appData[appDataKey].some(item => item[idKey] === newRecord[idKey]);
                    }
                    if (!exists) {
                        appData[appDataKey].push(newRecord);
                    }
                    break;
                case 'UPDATE':
                    const indexToUpdate = appData[appDataKey].findIndex(item => item[idKey] === newRecord[idKey]);
                    if (indexToUpdate !== -1) {
                        appData[appDataKey][indexToUpdate] = { ...appData[appDataKey][indexToUpdate], ...newRecord };
                    } else {
                        appData[appDataKey].push(newRecord);
                    }
                    break;
                case 'DELETE':
                    if (appDataKey === 'deal_tags') {
                        const oldIdNegocio = oldRecord.id_negocio_fk;
                        const oldIdTag = oldRecord.id_tag_fk;
                        if(oldIdNegocio && oldIdTag) {
                            appData.deal_tags = appData.deal_tags.filter(dt => !(dt.id_negocio_fk === oldIdNegocio && dt.id_tag_fk === oldIdTag));
                        }
                    } else {
                        const oldId = oldRecord[idKey];
                        if(oldId) appData[appDataKey] = appData[appDataKey].filter(item => item[idKey] != oldId);
                    }
                    break;
            }
            
            // Re-renderiza a view atual e o editor de mensagens se estiver aberto
            renderCurrentView();
            if (!messageEditorModal.classList.contains('hidden')) {
                renderMessagesEditor();
            }

            if (!dealModal.classList.contains('hidden')) {
                const openDealId = dealModalContent.querySelector('form')?.dataset.dealId;
                const relevantId = newRecord?.id_negocio || oldRecord?.id_negocio || newRecord?.id_negocio_fk || oldRecord?.id_negocio_fk;
                if (openDealId && relevantId == openDealId) {
                   showDealModal(openDealId);
                }
                 // NOVO: Se uma empresa for atualizada, recarrega o modal aberto para refletir o novo nome
                if (appDataKey === 'empresas') {
                     showDealModal(openDealId);
                }
            }
        }

        // --- LÓGICA DE RENDERIZAÇÃO PRINCIPAL ---
        function renderCurrentView() {
            if (currentView === 'kanban') {
                renderKanbanView();
            } else {
                renderListView();
            }
        }

        function getFilteredDeals() {
            let filteredDeals = appData.deals;
            if (filterOnlyMyDeals) {
                filteredDeals = filteredDeals.filter(deal => deal.id_usuario_responsavel_fk === currentUser.id_usuario);
            }
            if (activeTagId) {
                const dealIdsWithTag = appData.deal_tags.filter(dt => dt.id_tag_fk == activeTagId).map(dt => dt.id_negocio_fk);
                filteredDeals = filteredDeals.filter(deal => dealIdsWithTag.includes(deal.id_negocio));
            }
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm.length >= 2) {
                filteredDeals = filteredDeals.filter(deal => deal.nome_empresa.toLowerCase().includes(searchTerm));
            }
            return filteredDeals;
        }

        // --- RENDERIZAÇÃO DO QUADRO KANBAN ---
        function renderKanbanView() {
            const filteredDeals = getFilteredDeals();
            kanbanBoard.innerHTML = '';
            appData.columns.forEach(column => {
                const columnEl = document.createElement('div');
                columnEl.className = 'kanban-column bg-slate-100 rounded-lg p-3 w-[88vw] sm:w-80 flex-shrink-0';
                const dealsInColumn = filteredDeals.filter(d => d.id_coluna_fk === column.id_coluna);

                columnEl.innerHTML = `
                    <div class="column-header-expanded flex justify-between items-center mb-3 flex-shrink-0">
                        <div class="flex items-center min-w-0">
                            <h2 class="font-bold text-gray-700 truncate">${column.nome_coluna}</h2>
                            <span class="ml-2 bg-slate-200 text-slate-600 text-sm font-semibold rounded-full px-2">${dealsInColumn.length}</span>
                        </div>
                        <button type="button" class="collapse-btn text-gray-400 hover:text-gray-600"><i class="fa-solid fa-angles-left"></i></button>
                    </div>
                    <div class="column-header-collapsed hidden flex-col items-center justify-between h-full flex-shrink-0">
                        <div class="vertical-text font-bold text-gray-700">${column.nome_coluna}</div>
                        <span class="bg-slate-200 text-slate-600 text-sm font-semibold rounded-full w-6 h-6 flex items-center justify-center mb-2">${dealsInColumn.length}</span>
                    </div>
                    <div class="kanban-cards min-h-[100px]" data-column-id="${column.id_coluna}">
                        ${dealsInColumn.map(deal => createDealCard(deal)).join('')}
                    </div>
                `;
                kanbanBoard.appendChild(columnEl);
            });
            initializeDragAndDrop();
            initializeColumnControls();
        }

        function createDealCard(deal) {
            const responsibleUser = appData.users.find(u => u.id_usuario === deal.id_usuario_responsavel_fk);
            const dealTags = appData.deal_tags.filter(dt => dt.id_negocio_fk === deal.id_negocio).map(dt => appData.tags.find(t => t.id_tag === dt.id_tag_fk)).filter(Boolean);
            
            // NOVO: Encontra o nome da empresa de prospecção
            const prospectingCompany = appData.empresas.find(e => e.id === deal.id_empresa_fk);
            const prospectingCompanyHtml = prospectingCompany ? `<div class="text-xs text-slate-500 font-semibold mb-2 flex items-center gap-2"><i class="fa-solid fa-building"></i> ${prospectingCompany.nome_empresa}</div>` : '';

            let followupHtml = '';
            if (deal.fase_followup > 0) {
                const colors = ['bg-green-100 text-green-800', 'bg-blue-100 text-blue-800', 'bg-yellow-100 text-yellow-800', 'bg-purple-100 text-purple-800', 'bg-pink-100 text-pink-800'];
                const colorClass = colors[(deal.fase_followup - 1) % colors.length];
                followupHtml = `<div class="followup-badge ${colorClass}"><i class="fas fa-paper-plane text-xs"></i> Fase ${deal.fase_followup}</div>`;
            }

            let responsibleHtml = '';
            if (responsibleUser) {
                if (responsibleUser.foto_url) {
                    responsibleHtml = `<img src="${responsibleUser.foto_url}" alt="${responsibleUser.nome_usuario}" title="${responsibleUser.nome_usuario}" class="w-7 h-7 rounded-full object-cover">`;
                } else {
                    const initial = responsibleUser.nome_usuario ? responsibleUser.nome_usuario.charAt(0).toUpperCase() : '?';
                    responsibleHtml = `<div title="${responsibleUser.nome_usuario}" class="w-7 h-7 rounded-full bg-slate-300 flex items-center justify-center text-slate-600 font-bold text-sm">${initial}</div>`;
                }
            }

            let nextTaskHtml = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const pendingTasks = appData.tasks.filter(t => t.id_negocio_fk === deal.id_negocio && !t.concluido);
            
            const futureTasks = pendingTasks.filter(t => t.prazo_final && new Date(t.prazo_final) >= today).sort((a, b) => new Date(a.prazo_final) - new Date(b.prazo_final));
            const overdueTasks = pendingTasks.filter(t => t.prazo_final && new Date(t.prazo_final) < today).sort((a, b) => new Date(b.prazo_final) - new Date(a.prazo_final));
            const noDateTasks = pendingTasks.filter(t => !t.prazo_final);

            const nextTask = futureTasks[0] || overdueTasks[0] || noDateTasks[0] || null;

            if (nextTask) {
                let taskBadgeColorClass = 'bg-slate-500';
                let daysRemainingText = '';

                if (!nextTask.prazo_final) {
                    taskBadgeColorClass = 'bg-red-500';
                    daysRemainingText = 'Sem data';
                } else {
                    const dueDate = new Date(nextTask.prazo_final);
                    dueDate.setUTCHours(12,0,0,0);
                    today.setUTCHours(12,0,0,0);
                    
                    const diffTime = dueDate.getTime() - today.getTime();
                    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        taskBadgeColorClass = 'bg-red-500';
                        daysRemainingText = `Vencido`;
                    } else if (diffDays === 0) {
                        taskBadgeColorClass = 'bg-red-500';
                        daysRemainingText = `Hoje`;
                    } else if (diffDays === 1) {
                        taskBadgeColorClass = 'bg-red-500';
                        daysRemainingText = `${diffDays} dia`;
                    } else if (diffDays <= 3) {
                        taskBadgeColorClass = 'bg-red-500';
                        daysRemainingText = `${diffDays} dias`;
                    } else if (diffDays <= 7) {
                        taskBadgeColorClass = 'bg-yellow-500';
                        daysRemainingText = `${diffDays} dias`;
                    } else {
                        daysRemainingText = `${diffDays} dias`;
                    }
                }

                nextTaskHtml = `
                    <div class="task-wrapper relative group text-xs">
                        <div class="task-display transition-opacity duration-200 ease-in-out group-hover:opacity-0">
                            <div class="flex items-center justify-between gap-2 p-2 rounded-md bg-slate-100">
                                <div class="flex items-center gap-2 min-w-0">
                                    <i class="far fa-flag fa-sm w-4 text-center text-slate-500"></i>
                                    <span class="font-semibold flex-grow truncate text-slate-700" title="${nextTask.titulo_tarefa}">${nextTask.titulo_tarefa}</span>
                                </div>
                                <span class="font-bold flex-shrink-0 px-2 py-0.5 rounded-full text-white text-[10px] ${taskBadgeColorClass}">${daysRemainingText}</span>
                            </div>
                        </div>
                        <div class="task-actions absolute inset-0 flex opacity-0 group-hover:opacity-100 transition-opacity duration-200 ease-in-out rounded-md overflow-hidden">
                            <button type="button" class="complete-task-btn-card flex items-center justify-center w-1/3 h-full bg-green-500 hover:bg-green-600 text-white" title="Concluir Tarefa" data-task-id="${nextTask.id_tarefa}">
                                <i class="fas fa-check"></i>
                            </button>
                            <button type="button" class="edit-task-btn-card flex items-center justify-center w-1/3 h-full bg-yellow-500 hover:bg-yellow-600 text-white" title="Editar Tarefa" data-task-id="${nextTask.id_tarefa}" data-deal-id="${deal.id_negocio}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button type="button" class="delete-task-btn-card flex items-center justify-center w-1/3 h-full bg-red-500 hover:bg-red-600 text-white" title="Excluir Tarefa" data-task-id="${nextTask.id_tarefa}" data-deal-id="${deal.id_negocio}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            let whatsappHtml = '';
            if (deal.telefone_responsavel) {
                let cleanPhone = deal.telefone_responsavel.replace(/\D/g, '');
                if (cleanPhone.length >= 10 && !cleanPhone.startsWith('55')) {
                    cleanPhone = '55' + cleanPhone;
                }
                if (cleanPhone.length >= 12) {
                    const whatsappUrl = `https://web.whatsapp.com/send?phone=${cleanPhone}`;
                    whatsappHtml = `
                        <a href="${whatsappUrl}" target="_blank" class="whatsapp-btn text-green-500 hover:text-green-600 text-2xl" title="Conversar no WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                    `;
                }
            }

            // --- INÍCIO DA LÓGICA DO BALÃO DE REMARKETING ---
            let remarketingHtml = '';
            // Verifica se a negociação está na coluna 4 ou 5 e se qtd_msg_mkt é um número maior que 0
            if ((deal.id_coluna_fk === 4 || deal.id_coluna_fk === 5) && deal.qtd_msg_mkt > 0) {
                remarketingHtml = `
                    <div class="flex items-center gap-1 text-slate-500 hover:text-slate-700" title="Mensagens de Remarketing Recebidas: ${deal.qtd_msg_mkt}">
                        <i class="fas fa-bullhorn text-xl"></i>
                        <span class="font-bold text-sm">${deal.qtd_msg_mkt}</span>
                    </div>
                `;
            }
            // --- FIM DA LÓGICA DO BALÃO DE REMARKETING ---
            
            const tagsHtml = dealTags.map(tag => `<span class="text-xs font-medium mr-1 mb-1 px-2 py-0.5 rounded-full" style="background-color:${tag.cor}20; color:${tag.cor};">${tag.nome_tag}</span>`).join('');

            return `
                <div class="kanban-card bg-white rounded-lg p-3 mb-3 border border-gray-200 hover:border-green-400 hover:shadow-md cursor-pointer flex flex-col justify-between min-h-[150px]" data-deal-id="${deal.id_negocio}">
                    <div>
                        ${prospectingCompanyHtml} 
                        <div class="flex flex-wrap gap-y-1 mb-2">${tagsHtml}</div>
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-semibold text-gray-800 pr-2 flex-grow">${deal.nome_empresa}</h3>
                            <div class="flex-shrink-0">${followupHtml}</div>
                        </div>
                        <p class="text-sm text-gray-500 mb-2">${deal.nome_responsavel_empresa || 'Sem responsável'}</p>
                    </div>
                    
                    <div class="flex-grow my-2">
                        ${nextTaskHtml}
                    </div>

                    <div class="mt-auto pt-2 border-t border-gray-200 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            ${whatsappHtml}
                            ${remarketingHtml}
                        </div>
                        <div>
                            ${responsibleHtml}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- RENDERIZAÇÃO DA VISÃO DE LISTA (APRIMORADA) ---
        function formatDueDateForList(dateString) {
            if (!dateString) {
                return { text: 'Sem data', color: 'text-red-600 font-bold' };
            }
            const dueDate = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            dueDate.setUTCHours(12, 0, 0, 0); // Normaliza para evitar problemas de fuso horário

            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { text: `Vencido há ${Math.abs(diffDays)} dia(s)`, color: 'text-red-600 font-bold' };
            }
            if (diffDays === 0) {
                return { text: 'Hoje', color: 'text-red-500 font-bold' };
            }
            if (diffDays === 1) {
                return { text: 'Amanhã', color: 'text-yellow-600 font-semibold' };
            }
            return { text: `Em ${diffDays} dias`, color: 'text-gray-500' };
        }

        function renderListView() {
            let filteredDeals = getFilteredDeals();
            
            // NOVO: Aplica filtro de coluna se estiver ativo
            if (activeListColumnFilter) {
                filteredDeals = filteredDeals.filter(deal => deal.id_coluna_fk === activeListColumnFilter);
            }

            const dealIds = filteredDeals.map(d => d.id_negocio);
            
            let items = [];

            // 1. Coletar tarefas pendentes
            if (activeListViewFilter === 'all' || activeListViewFilter === 'tasks') {
                const pendingTasks = appData.tasks.filter(task => !task.concluido && dealIds.includes(task.id_negocio_fk));
                pendingTasks.forEach(task => {
                    const deal = appData.deals.find(d => d.id_negocio === task.id_negocio_fk);
                    if (deal) {
                        items.push({
                            type: 'task',
                            dueDate: task.prazo_final ? new Date(task.prazo_final) : null,
                            data: task,
                            deal: deal
                        });
                    }
                });
            }

            // 2. Coletar próximas mensagens de follow-up
            if (activeListViewFilter === 'all' || activeListViewFilter === 'messages') {
                const dealsWithFollowup = filteredDeals.filter(deal => deal.fase_followup > 0);
                
                dealsWithFollowup.forEach(deal => {
                    const dealTagIds = appData.deal_tags.filter(dt => dt.id_negocio_fk === deal.id_negocio).map(dt => dt.id_tag_fk);
                    const serviceTagIdsInMessages = [...new Set(appData.followup_messages.map(m => m.categoria_servico))];
                    
                    let serviceTagId = null;
                    for (const tagId of dealTagIds) {
                        if (serviceTagIdsInMessages.includes(tagId)) {
                            serviceTagId = tagId;
                            break;
                        }
                    }

                    if (serviceTagId) {
                        const sentLogsForDeal = appData.followup_logs
                            .filter(log => log.id_negocio_fk === deal.id_negocio)
                            .sort((a, b) => new Date(b.data_envio) - new Date(a.data_envio));
                        
                        const sentEtapas = sentLogsForDeal.map(log => log.etapa_enviada);
                        
                        const upcomingMessage = appData.followup_messages
                            .filter(m => m.categoria_servico === serviceTagId && !sentEtapas.includes(m.etapa))
                            .sort((a, b) => a.etapa - b.etapa)[0];

                        if (upcomingMessage) {
                            // CÁLCULO DA DATA DE VENCIMENTO DO FOLLOW-UP
                            const lastLog = sentLogsForDeal[0];
                            const baseDate = lastLog ? new Date(lastLog.data_envio) : new Date(deal.created_at);
                            const interval = upcomingMessage.intervalo_dias || 0;
                            const dueDate = new Date(baseDate);
                            dueDate.setDate(dueDate.getDate() + interval);

                            items.push({
                                type: 'message',
                                dueDate: dueDate,
                                data: upcomingMessage,
                                deal: deal
                            });
                        }
                    }
                });
            }

            // 3. Ordenar a lista
            items.sort((a, b) => {
                const aDate = a.dueDate;
                const bDate = b.dueDate;
                if (aDate === null && bDate === null) return 0;
                if (aDate === null) return -1;
                if (bDate === null) return 1;
                return aDate - bDate;
            });
            
            // 4. Renderizar HTML
            if (items.length === 0) {
                listViewContainer.innerHTML = `<div class="text-center text-gray-500 p-8">Nenhum item pendente para exibir.</div>`;
                return;
            }

            listViewContainer.innerHTML = items.map(item => {
                if (item.type === 'task') {
                    return createListViewTaskItem(item);
                } else {
                    return createListViewMessageItem(item);
                }
            }).join('');
        }

        function createListViewTaskItem(item) {
            const { data: task, deal, dueDate } = item;
            const { text: dateHtml, color: dateColor } = formatDueDateForList(dueDate?.toISOString());
            const responsibleUser = appData.users.find(u => u.id_usuario === task.id_usuario_responsavel_fk) || appData.users.find(u => u.id_usuario === deal.id_usuario_responsavel_fk);
            let responsibleHtml = '';
            if (responsibleUser) {
                if (responsibleUser.foto_url) {
                    responsibleHtml = `<img src="${responsibleUser.foto_url}" alt="${responsibleUser.nome_usuario}" title="${responsibleUser.nome_usuario}" class="w-8 h-8 rounded-full object-cover">`;
                } else {
                    const initial = responsibleUser.nome_usuario ? responsibleUser.nome_usuario.charAt(0).toUpperCase() : '?';
                    responsibleHtml = `<div title="${responsibleUser.nome_usuario}" class="w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center text-slate-600 font-bold text-sm">${initial}</div>`;
                }
            }

            return `
                <div class="list-view-item bg-white p-4 rounded-lg shadow-sm border flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition-colors" data-deal-id="${deal.id_negocio}">
                    <div class="flex-shrink-0">
                        <button class="complete-task-btn-list w-6 h-6 rounded-full border-2 border-gray-300 hover:border-green-500 focus:outline-none transition-colors" title="Marcar como concluída" data-task-id="${task.id_tarefa}"></button>
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${task.titulo_tarefa}</p>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-briefcase mr-1 text-gray-400"></i> ${deal.nome_empresa} &bull; <span class="${dateColor}"><i class="far fa-calendar-alt mr-1"></i> ${dateHtml}</span>
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        ${responsibleHtml}
                    </div>
                </div>
            `;
        }

        function createListViewMessageItem(item) {
            const { data: message, deal, dueDate } = item;
            const { text: dateHtml, color: dateColor } = formatDueDateForList(dueDate?.toISOString());
            const responsibleUser = appData.users.find(u => u.id_usuario === deal.id_usuario_responsavel_fk);
            let responsibleHtml = '';
            if (responsibleUser) {
                if (responsibleUser.foto_url) {
                    responsibleHtml = `<img src="${responsibleUser.foto_url}" alt="${responsibleUser.nome_usuario}" title="${responsibleUser.nome_usuario}" class="w-8 h-8 rounded-full object-cover">`;
                } else {
                    const initial = responsibleUser.nome_usuario ? responsibleUser.nome_usuario.charAt(0).toUpperCase() : '?';
                    responsibleHtml = `<div title="${responsibleUser.nome_usuario}" class="w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center text-slate-600 font-bold text-sm">${initial}</div>`;
                }
            }

            return `
                 <div class="list-view-item bg-white p-4 rounded-lg shadow-sm border flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition-colors" data-deal-id="${deal.id_negocio}">
                    <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center">
                        <i class="fas fa-comment-dots text-blue-500 text-xl"></i>
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${message.titulo} (Etapa ${message.etapa})</p>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-briefcase mr-1 text-gray-400"></i> ${deal.nome_empresa} &bull; <span class="${dateColor}"><i class="far fa-paper-plane mr-1"></i> ${dateHtml}</span>
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                         <button class="send-message-btn-list bg-green-500 hover:bg-green-600 text-white font-bold w-10 h-10 rounded-full flex items-center justify-center text-lg" data-deal-id="${deal.id_negocio}" data-etapa="${message.etapa}" data-message-id="${message.id_mensagem}" title="Enviar mensagem via WhatsApp">
                             <i class="fab fa-whatsapp"></i>
                         </button>
                    </div>
                    <div class="flex-shrink-0">
                        ${responsibleHtml}
                    </div>
                </div>
            `;
        }
        
        // --- FILTROS E CONTROLES ---
        function setupFilters() {
            const triggerBtn = document.getElementById('filter-trigger-btn');
            const popup = document.getElementById('filter-popup');
            const optionsContainer = document.getElementById('filter-options-container');
            const btnText = document.getElementById('filter-btn-text');
            const myDealsBtn = document.getElementById('my-deals-filter-btn');

            optionsContainer.innerHTML = `<a href="#" class="filter-tag-option text-gray-700 block px-4 py-2 text-sm" data-tag-id="">TODAS AS TAGS</a>`;
            appData.tags.forEach(tag => {
                const option = document.createElement('a');
                option.href = '#';
                option.className = 'filter-tag-option text-gray-700 block px-4 py-2 text-sm';
                option.dataset.tagId = tag.id_tag;
                option.innerHTML = `<div class="flex items-center"><span class="w-3 h-3 rounded-full mr-3" style="background-color: ${tag.cor};"></span><span>${tag.nome_tag}</span></div>`;
                optionsContainer.appendChild(option);
            });

            optionsContainer.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.filter-tag-option');
                if (!target) return;
                activeTagId = target.dataset.tagId ? parseInt(target.dataset.tagId) : null;
                btnText.textContent = target.textContent;
                popup.classList.add('hidden');
                renderCurrentView();
            });

            triggerBtn.addEventListener('click', () => popup.classList.toggle('hidden'));
            document.addEventListener('click', (e) => {
                if (!document.getElementById('filter-container').contains(e.target)) {
                    popup.classList.add('hidden');
                }
            });

            if (filterOnlyMyDeals) {
                myDealsBtn.classList.add('active');
            }
            myDealsBtn.addEventListener('click', () => {
                filterOnlyMyDeals = !filterOnlyMyDeals;
                myDealsBtn.classList.toggle('active');
                renderCurrentView();
            });
        }

        // NOVO: Função para configurar os filtros da visão de lista
        function setupListViewFilters() {
            const columnTriggerBtn = document.getElementById('column-filter-trigger-btn');
            const columnPopup = document.getElementById('column-filter-popup');
            const columnOptionsContainer = document.getElementById('column-filter-options-container');
            const columnBtnText = document.getElementById('column-filter-btn-text');

            // Popula o filtro de colunas
            columnOptionsContainer.innerHTML = `<a href="#" class="filter-column-option text-gray-700 block px-4 py-2 text-sm" data-column-id="">Todas as Colunas</a>`;
            appData.columns.forEach(column => {
                const option = document.createElement('a');
                option.href = '#';
                option.className = 'filter-column-option text-gray-700 block px-4 py-2 text-sm';
                option.dataset.columnId = column.id_coluna;
                option.textContent = column.nome_coluna;
                columnOptionsContainer.appendChild(option);
            });

            // Event listener para as opções do filtro de coluna
            columnOptionsContainer.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.filter-column-option');
                if (!target) return;
                activeListColumnFilter = target.dataset.columnId ? parseInt(target.dataset.columnId) : null;
                columnBtnText.textContent = target.textContent;
                columnPopup.classList.add('hidden');
                renderListView();
            });

            // Event listener para abrir/fechar o popup de coluna
            columnTriggerBtn.addEventListener('click', () => columnPopup.classList.toggle('hidden'));
            
            // Event listener para fechar o popup de coluna ao clicar fora
            document.addEventListener('click', (e) => {
                if (!document.getElementById('list-view-column-filter-container').contains(e.target)) {
                    columnPopup.classList.add('hidden');
                }
            });

            // Event listener para os filtros de tipo (Todos, Tarefas, Mensagens)
            document.getElementById('list-view-filters').addEventListener('click', (e) => {
                const target = e.target.closest('.list-filter-btn');
                if (target) {
                    activeListViewFilter = target.dataset.filter;
                    document.querySelectorAll('#list-view-filters .list-filter-btn').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');
                    renderListView();
                }
            });
        }

        function initializeDragAndDrop() {
            document.querySelectorAll('.kanban-cards').forEach(column => {
                new Sortable(column, {
                    group: 'kanban',
                    animation: 150,
                    delay: 100, // Adiciona um pequeno atraso para iniciar o arrasto em toque
                    delayOnTouchOnly: true, // Aplica o atraso apenas em dispositivos de toque
                    onEnd: async (evt) => {
                        const { item, to, from } = evt;
                        const dealId = item.dataset.dealId;
                        const newColumnId = to.dataset.columnId;
                        const originalColumnId = from.dataset.columnId;
                        
                        try {
                            const { error } = await dbClient.from('sf_negociacoes').update({ id_coluna_fk: newColumnId, updated_at: new Date().toISOString() }).eq('id_negocio', dealId);
                            if (error) throw error;
                            
                            const fromColumn = appData.columns.find(c => c.id_coluna == originalColumnId);
                            const toColumn = appData.columns.find(c => c.id_coluna == newColumnId);
                            await addHistoryEntry(dealId, 'Status Alterado', `Status alterado de "${fromColumn.nome_coluna}" para "${toColumn.nome_coluna}".`);
                        } catch (error) {
                            showToast('Erro ao atualizar status.');
                            console.error("Erro ao mover card:", error);
                            renderCurrentView();
                        }
                    }
                });
            });
        }
        
        function initializeColumnControls() {
            kanbanBoard.addEventListener('click', (e) => {
                const collapseBtn = e.target.closest('.collapse-btn');
                if (collapseBtn) {
                    e.stopPropagation();
                    collapseBtn.closest('.kanban-column').classList.toggle('collapsed');
                    return;
                }
                
                const collapsedColumn = e.target.closest('.kanban-column.collapsed');
                if (collapsedColumn) {
                    collapsedColumn.classList.remove('collapsed');
                }
            });
        }
        
        function setupEventListeners() {
            searchInput.addEventListener('input', renderCurrentView);
            
            kanbanBoard.addEventListener('click', (e) => {
                const whatsappBtn = e.target.closest('.whatsapp-btn');
                const completeBtn = e.target.closest('.complete-task-btn-card');
                const editBtn = e.target.closest('.edit-task-btn-card');
                const deleteBtn = e.target.closest('.delete-task-btn-card');

                if (whatsappBtn || completeBtn || editBtn || deleteBtn) {
                    e.stopPropagation();
                }

                if (completeBtn) {
                    handleToggleTask(completeBtn.dataset.taskId, true);
                    return;
                }
                if (editBtn) {
                    showTaskEditorModal(editBtn.dataset.taskId, editBtn.dataset.dealId);
                    return;
                }
                if (deleteBtn) {
                    showDeleteConfirmModal('task', deleteBtn.dataset.taskId, deleteBtn.dataset.dealId);
                    return;
                }

                const card = e.target.closest('.kanban-card');
                if (card) {
                    showDealModal(card.dataset.dealId);
                }
            });

            // Event Listeners para a visão de lista (APRIMORADO)
            document.getElementById('view-toggle-buttons').addEventListener('click', (e) => {
                const kanbanBtn = document.getElementById('kanban-view-btn');
                const listBtn = document.getElementById('list-view-btn');
                const target = e.target.closest('button');

                if (target && target.id === 'list-view-btn' && currentView !== 'list') {
                    currentView = 'list';
                    kanbanBoard.classList.add('hidden');
                    listView.classList.remove('hidden');
                    listBtn.classList.add('bg-white', 'shadow');
                    listBtn.classList.remove('text-gray-500');
                    kanbanBtn.classList.remove('bg-white', 'shadow');
                    kanbanBtn.classList.add('text-gray-500');
                    renderListView();
                } else if (target && target.id === 'kanban-view-btn' && currentView !== 'kanban') {
                    currentView = 'kanban';
                    listView.classList.add('hidden');
                    kanbanBoard.classList.remove('hidden');
                    kanbanBtn.classList.add('bg-white', 'shadow');
                    kanbanBtn.classList.remove('text-gray-500');
                    listBtn.classList.remove('bg-white', 'shadow');
                    listBtn.classList.add('text-gray-500');
                    renderKanbanView();
                }
            });
            
            listViewContainer.addEventListener('click', (e) => {
                const completeBtn = e.target.closest('.complete-task-btn-list');
                const sendBtn = e.target.closest('.send-message-btn-list');
                const listItem = e.target.closest('.list-view-item');

                if (completeBtn) {
                    e.stopPropagation();
                    handleToggleTask(completeBtn.dataset.taskId, true);
                    return;
                }

                if (sendBtn) {
                    e.stopPropagation();
                    handleSendMessageFromList(sendBtn);
                    return;
                }
                
                if (listItem) {
                    const dealId = listItem.dataset.dealId;
                    if (dealId) {
                        showDealModal(dealId);
                    }
                }
            });


            dealModal.addEventListener('click', (e) => {
                if (e.target === dealModal) hideDealModal();
            });
            document.getElementById('add-deal-btn').addEventListener('click', () => showDealModal(null));
            
            document.getElementById('cancel-delete-btn').addEventListener('click', hideDeleteConfirmModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                if (itemToDelete.type === 'task') {
                    handleDeleteTask(itemToDelete.id, itemToDelete.dealId);
                } else if (itemToDelete.type === 'deal') {
                    handleDeleteDeal(itemToDelete.id);
                } else if (itemToDelete.type === 'message') {
                    handleDeleteMessage(itemToDelete.id);
                }
                hideDeleteConfirmModal();
            });

            document.getElementById('cancel-send-btn').addEventListener('click', hideSendConfirmModal);
            document.getElementById('confirm-send-btn').addEventListener('click', handleConfirmSend);

            // NOVO: Event listeners para o editor de mensagens
            document.getElementById('close-message-editor-btn').addEventListener('click', hideMessagesEditor);
            messageEditorModal.addEventListener('click', (e) => {
                if (e.target.id === 'add-new-message-btn') {
                    showMessageForm();
                }
                const editBtn = e.target.closest('.edit-message-btn');
                if (editBtn) {
                    showMessageForm(editBtn.dataset.messageId);
                }
            });
        }
        
        function setupUserMenu() {
            const userAvatarBtn = document.getElementById('user-avatar-btn');
            const logoutPopup = document.getElementById('logout-popup');
            const adminOptionsContainer = document.getElementById('admin-options');
            
            const userInitial = currentUser.nome_usuario ? currentUser.nome_usuario.charAt(0).toUpperCase() : '?';
            userAvatarBtn.innerHTML = currentUser.foto_url ? `<img src="${currentUser.foto_url}" class="w-full h-full object-cover">` : `<span>${userInitial}</span>`;
            document.getElementById('popup-user-name').textContent = currentUser.nome_usuario;
            document.getElementById('popup-user-email').textContent = currentUser.email;

            // Adiciona opções de admin se o usuário for admin
            adminOptionsContainer.innerHTML = '';
            if (currentUser.nivel_acesso === 'admin') {
                const editMessagesLink = document.createElement('a');
                editMessagesLink.href = '#';
                editMessagesLink.id = 'edit-messages-btn';
                editMessagesLink.className = 'block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 border-t';
                editMessagesLink.innerHTML = '<i class="fas fa-envelope-open-text mr-2"></i>Editar Mensagens';
                adminOptionsContainer.appendChild(editMessagesLink);

                editMessagesLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    logoutPopup.classList.add('hidden');
                    showMessagesEditor();
                });
            }

            userAvatarBtn.addEventListener('click', () => logoutPopup.classList.toggle('hidden'));
            document.getElementById('popup-logout-btn').addEventListener('click', (e) => { e.preventDefault(); showLogin(); });
        }

        async function showDealModal(dealId) {
            dealModalContent.innerHTML = loaderTemplate.content.cloneNode(true).outerHTML;
            dealModal.classList.remove('hidden');
            requestAnimationFrame(() => dealModalContent.classList.remove('scale-95', 'opacity-0'));

            let deal = { id_coluna_fk: 1, fase_followup: 0 };
            if (dealId) {
                deal = appData.deals.find(d => d.id_negocio == dealId);
                if (!deal) {
                    showToast("Negociação não encontrada.");
                    hideDealModal();
                    return;
                }
                const { data: historyData, error } = await dbClient.from('sf_historico_negociacao').select('*, sf_usuarios(nome_usuario)').eq('id_negocio_fk', dealId).order('timestamp', { ascending: false });
                appData.history = error ? [] : historyData;
            } else {
                appData.history = [];
            }

            const tasksForDeal = appData.tasks.filter(t => t.id_negocio_fk == dealId);
            const usersOptions = appData.users.map(u => `<option value="${u.id_usuario}" ${deal.id_usuario_responsavel_fk == u.id_usuario ? 'selected' : ''}>${u.nome_usuario}</option>`).join('');
            const columnsOptions = appData.columns.map(c => `<option value="${c.id_coluna}" ${deal.id_coluna_fk == c.id_coluna ? 'selected' : ''}>${c.nome_coluna}</option>`).join('');
            
            // NOVO: Cria as opções para o seletor de empresas
            const empresasOptions = appData.empresas.map(e => `<option value="${e.id}" ${deal.id_empresa_fk == e.id ? 'selected' : ''}>${e.nome_empresa}</option>`).join('');

            const dealTagIds = appData.deal_tags.filter(dt => dt.id_negocio_fk == dealId).map(dt => dt.id_tag_fk);
            const tagsCheckboxesHtml = appData.tags.map(tag => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" class="deal-tag-checkbox" data-tag-id="${tag.id_tag}" ${dealTagIds.includes(tag.id_tag) ? 'checked' : ''}>
                    <span class="text-sm font-medium px-2 py-0.5 rounded-full" style="background-color:${tag.cor}20; color:${tag.cor};">${tag.nome_tag}</span>
                </label>
            `).join('');

            dealModalContent.innerHTML = `
                <form data-deal-id="${dealId || ''}" class="flex flex-col h-full">
                    <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">${dealId ? deal.nome_empresa : 'Nova Negociação'}</h2>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-600">Ativar Follow-up</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="followup-toggle" ${deal.fase_followup > 0 ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <button type="button" id="close-deal-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>
                    <div class="border-b border-gray-200 flex-shrink-0"><nav class="modal-tabs flex space-x-4 px-6 -mb-px"><button type="button" data-tab="details" class="tab-button active">Detalhes</button><button type="button" data-tab="followup" class="tab-button">Follow-up</button><button type="button" data-tab="tasks" class="tab-button">Tarefas <span id="task-badge" class="tab-badge">${tasksForDeal.length}</span></button><button type="button" data-tab="history" class="tab-button">Histórico</button></nav></div>
                    <div class="p-6 overflow-y-auto flex-grow">
                        <div id="tab-content-details" class="tab-content active space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- NOVO: Campo para selecionar a empresa da prospecção -->
                                <div class="md:col-span-2">
                                    <label class="font-medium">Empresa da Prospecção</label>
                                    <select name="id_empresa_fk" class="form-input" required>
                                        <option value="">Selecione a empresa...</option>
                                        ${empresasOptions}
                                    </select>
                                </div>
                                <div><label class="font-medium">Nome da Empresa (Lead)</label><input name="nome_empresa" value="${deal.nome_empresa || ''}" class="form-input" required></div>
                                <div><label class="font-medium">Nome do Responsável</label><input name="nome_responsavel_empresa" value="${deal.nome_responsavel_empresa || ''}" class="form-input"></div>
                                <div><label class="font-medium">Telefone</label><input name="telefone_responsavel" value="${deal.telefone_responsavel || ''}" class="form-input"></div>
                                <div><label class="font-medium">Rede Social (Link)</label><input name="redesocial" value="${deal.redesocial || ''}" class="form-input"></div>
                                <div><label class="font-medium">Responsável CRM</label><select name="id_usuario_responsavel_fk" class="form-input"><option value="">Nenhum</option>${usersOptions}</select></div>
                                <div><label class="font-medium">Status</label><select name="id_coluna_fk" class="form-input">${columnsOptions}</select></div>
                            </div>
                            <div>
                                <label class="font-medium">Tags</label>
                                <div class="mt-2 p-3 bg-slate-50 rounded-lg flex flex-wrap gap-4">${tagsCheckboxesHtml}</div>
                            </div>
                        </div>
                        <div id="tab-content-followup" class="tab-content space-y-6"></div>
                        <div id="tab-content-tasks" class="tab-content"><div id="task-list-container" class="space-y-2 mb-4"></div><div class="flex gap-2"><input id="new-task-title" class="form-input flex-grow" placeholder="Nova tarefa..."><button type="button" id="add-task-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 rounded-lg font-semibold">Add</button></div></div>
                        <div id="tab-content-history" class="tab-content"><div id="history-list-container" class="space-y-3 mb-4"></div><div class="flex gap-2"><textarea id="new-history-note" class="form-input flex-grow" placeholder="Adicionar uma nota..."></textarea><button type="button" id="add-note-btn" class="bg-blue-500 text-white px-4 rounded-lg font-semibold">Salvar</button></div></div>
                    </div>
                    <div class="p-4 border-t bg-slate-50 flex justify-end items-center gap-3 flex-shrink-0">
                        ${dealId ? `<button type="button" id="delete-deal-btn" class="text-red-500 hover:text-red-700 font-semibold mr-auto">Excluir Negociação</button>` : ''}
                        <button type="button" id="cancel-deal-btn" class="px-4 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-full font-semibold">Cancelar</button>
                        <button type="submit" id="save-deal-btn" class="px-4 py-2 text-white bg-green-500 hover:bg-green-600 rounded-full font-semibold">Salvar</button>
                    </div>
                </form>
            `;
            
            renderTasks(dealId);
            renderHistory(dealId);
            if (dealId) renderFollowupTab(deal);
            setupModalTabs();
            setupModalActions(dealId);
        }

        function hideDealModal() {
            dealModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => dealModal.classList.add('hidden'), 300);
        }
        
        function setupModalTabs() {
            const tabs = dealModalContent.querySelectorAll('.tab-button');
            const contents = dealModalContent.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    dealModalContent.querySelector(`#tab-content-${tab.dataset.tab}`).classList.add('active');
                });
            });
        }
        
        function setupModalActions(dealId) {
            const form = dealModalContent.querySelector('form');
            form.addEventListener('submit', (e) => { e.preventDefault(); handleSaveDeal(dealId); });
            
            document.getElementById('close-deal-modal-btn').addEventListener('click', hideDealModal);
            document.getElementById('cancel-deal-btn').addEventListener('click', hideDealModal);
            
            if (dealId) {
                document.getElementById('delete-deal-btn').addEventListener('click', () => showDeleteConfirmModal('deal', dealId));
                document.querySelectorAll('.deal-tag-checkbox').forEach(cb => {
                    cb.addEventListener('change', (e) => handleTagChange(dealId, e.target.dataset.tagId, e.target.checked));
                });
                document.getElementById('followup-toggle').addEventListener('change', (e) => handleFollowupToggle(dealId, e.target.checked));
            }
            
            document.getElementById('add-task-btn').addEventListener('click', () => handleAddTask(dealId));
            document.getElementById('add-note-btn').addEventListener('click', () => handleAddNote(dealId));
            
            const taskListContainer = document.getElementById('task-list-container');
            taskListContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-task-btn');
                if (editBtn) {
                    showTaskEditorModal(editBtn.dataset.taskId, editBtn.dataset.dealId);
                }

                const deleteBtn = e.target.closest('.delete-task-btn');
                if (deleteBtn) {
                    showDeleteConfirmModal('task', deleteBtn.dataset.taskId, deleteBtn.dataset.dealId);
                }
            });
             taskListContainer.addEventListener('change', (e) => {
                const checkbox = e.target.closest('.task-checkbox');
                if (checkbox) {
                    handleToggleTask(checkbox.dataset.taskId, checkbox.checked);
                }
            });

            const followupContainer = document.getElementById('tab-content-followup');
            followupContainer.addEventListener('click', (e) => {
                const sendBtn = e.target.closest('.manual-send-btn');
                if (sendBtn) {
                    handleManualSend(sendBtn, dealId);
                }
            });
        }

        async function handleSaveDeal(dealId) {
            const form = dealModalContent.querySelector('form');
            const formData = new FormData(form);
            const dealData = Object.fromEntries(formData.entries());
            dealData.updated_at = new Date().toISOString();
            
            // Validação simples para garantir que a empresa foi selecionada
            if (!dealData.id_empresa_fk) {
                showToast("Erro: É obrigatório selecionar a empresa da prospecção.");
                return;
            }

            try {
                if (dealId) {
                    const { data, error } = await dbClient.from('sf_negociacoes').update(dealData).eq('id_negocio', dealId).select().single();
                    if (error) throw error;
                    const index = appData.deals.findIndex(d => d.id_negocio == dealId);
                    if (index > -1) appData.deals[index] = { ...appData.deals[index], ...data };
                    showToast("Negociação atualizada!");
                } else {
                    const { data, error } = await dbClient.from('sf_negociacoes').insert(dealData).select().single();
                    if (error) throw error;
                    appData.deals.push(data);
                    await addHistoryEntry(data.id_negocio, 'Criação', 'Negociação criada.');
                    showToast("Negociação criada!");
                }
                
                hideDealModal();
                renderCurrentView();
            } catch (error) {
                showToast("Erro ao salvar: " + error.message);
                console.error(error);
            }
        }
        
        async function handleDeleteDeal(dealId) {
            try {
                const { error } = await dbClient.from('sf_negociacoes').delete().eq('id_negocio', dealId);
                if (error) throw error;
                appData.deals = appData.deals.filter(d => d.id_negocio != dealId);
                showToast("Negociação excluída.");
                hideDealModal();
                renderCurrentView();
            } catch (error) {
                showToast("Erro ao excluir: " + error.message);
            }
        }
        
        async function handleTagChange(dealId, tagId, isChecked) {
            const record = { id_negocio_fk: dealId, id_tag_fk: parseInt(tagId) };
            if (isChecked) {
                const { data, error } = await dbClient.from('sf_negociacao_tags').insert(record).select().single();
                if (!error) appData.deal_tags.push(data);
            } else {
                const { error } = await dbClient.from('sf_negociacao_tags').delete().match(record);
                if (!error) {
                    appData.deal_tags = appData.deal_tags.filter(dt => !(dt.id_negocio_fk == dealId && dt.id_tag_fk == parseInt(tagId)));
                }
            }
            const deal = appData.deals.find(d => d.id_negocio == dealId);
            renderFollowupTab(deal);
            renderCurrentView();
        }

        async function handleFollowupToggle(dealId, isChecked) {
            const newPhase = isChecked ? 1 : 0;
            const { error } = await dbClient.from('sf_negociacoes').update({ fase_followup: newPhase }).eq('id_negocio', dealId);

            if (error) {
                showToast("Erro ao atualizar follow-up.");
            } else {
                const dealIndex = appData.deals.findIndex(d => d.id_negocio == dealId);
                if (dealIndex > -1) {
                    appData.deals[dealIndex].fase_followup = newPhase;
                }
                const message = isChecked ? "Follow-up ativado." : "Follow-up desativado.";
                showToast(message);
                await addHistoryEntry(dealId, "Follow-up", message);
                renderCurrentView();
                const deal = appData.deals.find(d => d.id_negocio == dealId);
                renderFollowupTab(deal);
            }
        }
        
        async function renderFollowupTab(deal) {
            const container = document.getElementById('tab-content-followup');
            if (!container) return;

            container.innerHTML = loaderTemplate.content.cloneNode(true).outerHTML;

            if (deal.fase_followup === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center p-4">Ative o Follow-up na aba "Detalhes" para ver as mensagens.</p>`;
                return;
            }

            const dealTagIds = appData.deal_tags.filter(dt => dt.id_negocio_fk === deal.id_negocio).map(dt => dt.id_tag_fk);
            const serviceTagIdsInMessages = [...new Set(appData.followup_messages.map(m => m.categoria_servico))];
            
            let serviceTagId = null;
            for (const tagId of dealTagIds) {
                if (serviceTagIdsInMessages.includes(tagId)) {
                    serviceTagId = tagId;
                    break;
                }
            }
            
            if (!serviceTagId) {
                container.innerHTML = `<p class="text-gray-500 text-center p-4">Para carregar a cadência, adicione uma tag de serviço (ex: CHATBOT, TRÁFEGO PAGO) na aba "Detalhes".</p>`;
                return;
            }

            const { data: sentLogs, error: logError } = await dbClient.from('log_envios_followup').select('*').eq('id_negocio_fk', deal.id_negocio);
            
            if (logError) {
                container.innerHTML = `<p class="text-red-500 text-center p-4">Erro ao carregar o histórico de envios.</p>`;
                console.error(logError);
                return;
            }

            const allMessagesForService = appData.followup_messages.filter(m => m.categoria_servico === serviceTagId).sort((a, b) => a.etapa - b.etapa);
            const sentEtapas = sentLogs.map(log => log.etapa_enviada);
            const sentMessages = allMessagesForService.filter(m => sentEtapas.includes(m.etapa));
            const upcomingMessages = allMessagesForService.filter(m => !sentEtapas.includes(m.etapa));

            let finalHtml = '';

            finalHtml += '<div><h3 class="text-lg font-semibold text-gray-800 mb-2">Mensagens Enviadas</h3>';
            if (sentMessages.length > 0) {
                finalHtml += '<div class="space-y-2">';
                sentMessages.forEach(msg => {
                    const log = sentLogs.find(l => l.etapa_enviada === msg.etapa);
                    const sentDate = new Date(log.data_envio).toLocaleString('pt-BR');
                    finalHtml += `
                        <div class="p-3 bg-slate-100 rounded-lg flex items-center gap-4">
                            <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            <div>
                                <p class="font-semibold text-gray-700">${msg.titulo}</p>
                                <p class="text-xs text-gray-500">Enviado em: ${sentDate}</p>
                            </div>
                        </div>
                    `;
                });
                finalHtml += '</div>';
            } else {
                finalHtml += '<p class="text-gray-500 text-sm">Nenhuma mensagem foi enviada ainda.</p>';
            }
            finalHtml += '</div>';

            finalHtml += '<div><h3 class="text-lg font-semibold text-gray-800 mb-2">Próximas Mensagens</h3>';
            if (upcomingMessages.length > 0) {
                finalHtml += '<div class="space-y-3">';
                upcomingMessages.forEach(msg => {
                    let intervalText = 'Não definido';
                    if (typeof msg.intervalo_dias === 'number' && msg.intervalo_dias !== null) {
                        if (msg.intervalo_dias === 0) {
                            intervalText = 'Envio imediato';
                        } else if (msg.intervalo_dias === 1) {
                            intervalText = 'Enviar em 1 dia';
                        } else {
                            intervalText = `Enviar em ${msg.intervalo_dias} dias`;
                        }
                    }

                    const personalizedMessage = msg.corpo_mensagem.replace(/\[Nome do Cliente\]/g, deal.nome_responsavel_empresa || 'Cliente');
                    finalHtml += `
                        <div class="p-4 border rounded-lg bg-white">
                            <div class="flex justify-between items-center mb-2">
                                <p class="font-semibold text-gray-700">${msg.titulo} (Etapa ${msg.etapa})</p>
                                <span class="text-xs font-semibold bg-slate-200 text-slate-600 px-2 py-1 rounded-full"><i class="far fa-clock mr-1"></i> ${intervalText}</span>
                            </div>
                            <textarea id="msg-textarea-${msg.id_mensagem}" class="form-input w-full text-sm" rows="4">${personalizedMessage}</textarea>
                            <div class="flex justify-end mt-2">
                                <button type="button" class="manual-send-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full flex items-center gap-2"
                                    data-etapa="${msg.etapa}"
                                    data-textarea-id="msg-textarea-${msg.id_mensagem}"
                                    title="Enviar mensagem via WhatsApp">
                                    <i class="fab fa-whatsapp"></i>
                                    <span>Enviar Manualmente</span>
                                </button>
                            </div>
                        </div>
                    `;
                });
                finalHtml += '</div>';
            } else {
                finalHtml += '<p class="text-gray-500 text-sm">Todas as mensagens desta cadência já foram enviadas.</p>';
            }
            finalHtml += '</div>';

            container.innerHTML = finalHtml;
        }

        async function handleManualSend(button, dealId) {
            const deal = appData.deals.find(d => d.id_negocio == dealId);
            if (!deal || !deal.telefone_responsavel) {
                showToast("Número de telefone não encontrado para esta negociação.");
                return;
            }

            const etapa = button.dataset.etapa;
            const textareaId = button.dataset.textareaId;
            const messageText = document.getElementById(textareaId).value;

            let cleanPhone = deal.telefone_responsavel.replace(/\D/g, '');
            if (cleanPhone.length >= 10 && !cleanPhone.startsWith('55')) {
                cleanPhone = '55' + cleanPhone;
            }
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(messageText)}`;
            window.open(whatsappUrl, '_blank');

            showSendConfirmModal(dealId, etapa);
        }

        function handleSendMessageFromList(button) {
             const dealId = button.dataset.dealId;
             const etapa = button.dataset.etapa;
             const messageId = button.dataset.messageId;

             const deal = appData.deals.find(d => d.id_negocio == dealId);
             const message = appData.followup_messages.find(m => m.id_mensagem == messageId);

             if (!deal || !message || !deal.telefone_responsavel) {
                 showToast("Não foi possível enviar a mensagem. Verifique os dados da negociação.");
                 return;
             }

             const personalizedMessage = message.corpo_mensagem.replace(/\[Nome do Cliente\]/g, deal.nome_responsavel_empresa || 'Cliente');
             let cleanPhone = deal.telefone_responsavel.replace(/\D/g, '');
             if (cleanPhone.length >= 10 && !cleanPhone.startsWith('55')) {
                 cleanPhone = '55' + cleanPhone;
             }
             const whatsappUrl = `https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(personalizedMessage)}`;
             window.open(whatsappUrl, '_blank');

             showSendConfirmModal(dealId, etapa);
        }
        
        async function handleConfirmSend() {
            const { dealId, etapa } = followupToSend;
            if (!dealId || !etapa) return;

            try {
                const logEntry = {
                    id_negocio_fk: dealId,
                    etapa_enviada: parseInt(etapa),
                    data_envio: new Date().toISOString()
                };
                const { data: logData, error: logError } = await dbClient.from('log_envios_followup').insert(logEntry).select().single();
                if (logError) throw logError;
                appData.followup_logs.push(logData);
                
                const proximaFase = parseInt(etapa) + 1;
                const { error: updateError } = await dbClient.from('sf_negociacoes').update({ fase_followup: proximaFase }).eq('id_negocio', dealId);
                if (updateError) throw updateError;

                const dealIndex = appData.deals.findIndex(d => d.id_negocio == dealId);
                if (dealIndex > -1) {
                    appData.deals[dealIndex].fase_followup = proximaFase;
                }

                showToast(`Envio da Etapa ${etapa} registrado!`);
                
                await addHistoryEntry(dealId, 'Follow-up Manual', `Mensagem da Etapa ${etapa} confirmada. Negócio na fase ${proximaFase}.`);
                
                hideSendConfirmModal();
                if (!dealModal.classList.contains('hidden')) {
                    showDealModal(dealId);
                }
                renderCurrentView();
                
            } catch (error) {
                showToast("Erro ao registrar o envio. Verifique as permissões da tabela.");
                console.error("Erro ao confirmar envio:", error);
                hideSendConfirmModal();
            }
        }
        
        function renderTasks(dealId) {
            const container = document.getElementById('task-list-container');
            if (!container) return;
            
            const allTasks = appData.tasks.filter(t => t.id_negocio_fk == dealId);
            document.getElementById('task-badge').textContent = allTasks.length;

            const pendingTasks = allTasks.filter(t => !t.concluido);
            const completedTasks = allTasks.filter(t => t.concluido);

            pendingTasks.sort((a, b) => {
                if (a.prazo_final && b.prazo_final) return new Date(a.prazo_final) - new Date(b.prazo_final);
                if (a.prazo_final) return -1;
                if (b.prazo_final) return 1;
                return 0;
            });

            const createTaskHtml = (task) => {
                const responsibleUser = appData.users.find(u => u.id_usuario === task.id_usuario_responsavel_fk);
                const dueDate = task.prazo_final ? new Date(task.prazo_final).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : null;
                
                let detailsHtml = '';
                if (dueDate || responsibleUser) {
                    detailsHtml += '<span class="text-xs text-gray-500 ml-2">';
                    if (dueDate) detailsHtml += `<i class="far fa-calendar-alt mr-1"></i>${dueDate}`;
                    if (dueDate && responsibleUser) detailsHtml += ' &bull; ';
                    if (responsibleUser) detailsHtml += `<i class="far fa-user mr-1"></i>${responsibleUser.nome_usuario}`;
                    detailsHtml += '</span>';
                }

                return `
                <div class="flex items-center p-2 bg-slate-50 rounded-md group">
                    <input type="checkbox" data-task-id="${task.id_tarefa}" class="task-checkbox h-4 w-4 mr-3 flex-shrink-0" ${task.concluido ? 'checked' : ''}>
                    <div class="flex-grow">
                        <span class="${task.concluido ? 'line-through text-gray-400' : ''}">${task.titulo_tarefa}</span>
                        ${detailsHtml}
                    </div>
                    <div class="task-controls opacity-0 group-hover:opacity-100 transition-opacity">
                        <button type="button" class="edit-task-btn text-gray-400 hover:text-blue-500 p-1" data-task-id="${task.id_tarefa}" data-deal-id="${dealId}"><i class="fas fa-pencil-alt"></i></button>
                        <button type="button" class="delete-task-btn text-gray-400 hover:text-red-500 p-1" data-task-id="${task.id_tarefa}" data-deal-id="${dealId}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            };

            let finalHtml = '';
            if (pendingTasks.length > 0) {
                finalHtml += pendingTasks.map(createTaskHtml).join('');
            }

            if (completedTasks.length > 0) {
                if(pendingTasks.length > 0) {
                    finalHtml += `<div class="mt-4 pt-2 border-t"><h4 class="text-sm font-semibold text-gray-500 mb-2">Concluídas</h4></div>`;
                }
                finalHtml += completedTasks.map(createTaskHtml).join('');
            }

            if (allTasks.length === 0) {
                finalHtml = '<p class="text-gray-500 text-center">Nenhuma tarefa.</p>';
            }

            container.innerHTML = finalHtml;
        }
        
        async function handleToggleTask(taskId, isChecked) {
            const { error } = await dbClient.from('sf_tarefas').update({ concluido: isChecked }).eq('id_tarefa', taskId);
            if (error) {
                showToast("Erro ao atualizar tarefa.");
                return;
            }

            const taskIndex = appData.tasks.findIndex(t => t.id_tarefa == taskId);
            if (taskIndex > -1) {
                const dealId = appData.tasks[taskIndex].id_negocio_fk;
                appData.tasks[taskIndex].concluido = isChecked;

                if (!dealModal.classList.contains('hidden')) {
                    const openDealId = dealModalContent.querySelector('form')?.dataset.dealId;
                    if (openDealId == dealId) {
                        renderTasks(dealId);
                    }
                }
                
                renderCurrentView();
                showToast(isChecked ? "Tarefa concluída!" : "Tarefa reaberta!");
            }
        }
        
        async function handleDeleteTask(taskId, dealId) {
            const { error } = await dbClient.from('sf_tarefas').delete().eq('id_tarefa', taskId);
            if (error) {
                showToast("Erro ao excluir tarefa.");
            } else {
                showToast("Tarefa excluída.");
                appData.tasks = appData.tasks.filter(t => t.id_tarefa != taskId);
                
                if (!dealModal.classList.contains('hidden')) {
                    const openDealId = dealModalContent.querySelector('form')?.dataset.dealId;
                    if (openDealId == dealId) {
                        renderTasks(dealId);
                    }
                }
                renderCurrentView();
            }
        }
        
        async function handleAddTask(dealId) {
            const titleInput = document.getElementById('new-task-title');
            if (!titleInput.value.trim() || !dealId) return;
            
            const taskData = { id_negocio_fk: dealId, titulo_tarefa: titleInput.value.trim(), id_usuario_responsavel_fk: currentUser.id_usuario };
            const { data, error } = await dbClient.from('sf_tarefas').insert(taskData).select().single();
            
            if (error) {
                showToast("Erro ao adicionar tarefa.");
            } else {
                appData.tasks.push(data);
                renderTasks(dealId);
                titleInput.value = '';
                await addHistoryEntry(dealId, 'Tarefa Adicionada', `Tarefa "${data.titulo_tarefa}" foi criada.`);
            }
        }
        
        function showTaskEditorModal(taskId, dealId) {
            const task = appData.tasks.find(t => t.id_tarefa == taskId);
            if (!task) {
                console.error("Tarefa não encontrada com ID:", taskId);
                return;
            }

            const editorModal = document.getElementById('task-editor-modal');
            const editorContent = document.getElementById('task-editor-content');
            
            const usersOptions = appData.users.map(user => `<option value="${user.id_usuario}" ${task.id_usuario_responsavel_fk == user.id_usuario ? 'selected' : ''}>${user.nome_usuario}</option>`).join('');
            const deadline = task.prazo_final ? task.prazo_final.split('T')[0] : '';
            
            editorContent.innerHTML = `
                <form id="task-editor-form" data-task-id="${taskId}" data-deal-id="${dealId}">
                    <div class="p-6 border-b"><h3 class="text-xl font-bold">Editar Tarefa</h3></div>
                    <div class="p-6 space-y-4">
                        <div><label class="font-medium">Título da Tarefa</label><input type="text" id="edit-task-title" value="${task.titulo_tarefa || ''}" class="form-input" required></div>
                        <div><label class="font-medium">Descrição</label><textarea id="edit-task-description" class="form-input" rows="4" placeholder="Adicione detalhes sobre a tarefa...">${task.descricao || ''}</textarea></div>
                        <div><label class="font-medium">Prazo Final</label><input type="date" id="edit-task-deadline" value="${deadline}" class="form-input"></div>
                        <div><label class="font-medium">Responsável</label><select id="edit-task-responsible" class="form-input"><option value="">Nenhum</option>${usersOptions}</select></div>
                    </div>
                    <div class="p-4 bg-slate-50 flex justify-end gap-3">
                        <button type="button" id="cancel-edit-task-btn" class="px-4 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-full font-semibold">Cancelar</button>
                        <button type="submit" class="px-4 py-2 text-white bg-green-500 hover:bg-green-600 rounded-full font-semibold">Salvar Alterações</button>
                    </div>
                </form>
            `;

            editorModal.classList.remove('hidden');
            requestAnimationFrame(() => editorContent.classList.remove('scale-95', 'opacity-0'));

            document.getElementById('task-editor-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleUpdateTask(taskId, dealId);
            });
            document.getElementById('cancel-edit-task-btn').addEventListener('click', hideTaskEditorModal);
        }

        function hideTaskEditorModal() {
            const editorModal = document.getElementById('task-editor-modal');
            const editorContent = document.getElementById('task-editor-content');
            editorContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => editorModal.classList.add('hidden'), 300);
        }
        
        async function handleUpdateTask(taskId, dealId) {
            const updatedData = {
                titulo_tarefa: document.getElementById('edit-task-title').value,
                descricao: document.getElementById('edit-task-description').value,
                prazo_final: document.getElementById('edit-task-deadline').value || null,
                id_usuario_responsavel_fk: document.getElementById('edit-task-responsible').value || null
            };
            
            const { data, error } = await dbClient.from('sf_tarefas').update(updatedData).eq('id_tarefa', taskId).select().single();
            
            if (error) {
                showToast("Erro ao atualizar tarefa.");
                console.error("Erro ao atualizar tarefa:", error);
            } else {
                showToast("Tarefa atualizada com sucesso!");
                const taskIndex = appData.tasks.findIndex(t => t.id_tarefa == taskId);
                if (taskIndex > -1) appData.tasks[taskIndex] = data;
                hideTaskEditorModal();
                renderTasks(dealId);
                renderCurrentView();
            }
        }

        // --- LÓGICA DE MODAIS DE CONFIRMAÇÃO ---
        function showDeleteConfirmModal(type, id, dealId = null) {
            itemToDelete = { type, id, dealId };
            const modalContent = deleteConfirmModal.querySelector('.bg-white');
            const messageEl = document.getElementById('delete-confirm-message');
            messageEl.textContent = `Tem certeza que deseja excluir est${type === 'task' ? 'a tarefa' : (type === 'message' ? 'a mensagem' : 'a negociação')}? Esta ação não pode ser desfeita.`;
            
            deleteConfirmModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            });
        }

        function hideDeleteConfirmModal() {
            const modalContent = deleteConfirmModal.querySelector('.bg-white');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                deleteConfirmModal.classList.add('hidden');
                itemToDelete = { type: null, id: null, dealId: null };
            }, 300);
        }

        function showSendConfirmModal(dealId, etapa) {
            followupToSend = { dealId, etapa };
            const modalContent = sendConfirmModal.querySelector('.bg-white');
            sendConfirmModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            });
        }

        function hideSendConfirmModal() {
            const modalContent = sendConfirmModal.querySelector('.bg-white');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                sendConfirmModal.classList.add('hidden');
                followupToSend = { dealId: null, etapa: null };
            }, 300);
        }
        
        // --- LÓGICA DE HISTÓRICO ---
        function renderHistory(dealId) {
            const container = document.getElementById('history-list-container');
            if (!container) return;
            const history = appData.history.filter(h => h.id_negocio_fk == dealId);
            container.innerHTML = history.length > 0
                ? history.map(entry => `
                    <div class="p-2 bg-slate-50 rounded-md">
                        <p class="text-sm">${entry.descricao}</p>
                        <p class="text-xs text-gray-500 mt-1">${entry.sf_usuarios?.nome_usuario || 'Sistema'} - ${new Date(entry.timestamp).toLocaleString('pt-BR')}</p>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-center">Nenhum histórico.</p>';
        }
        
        async function handleAddNote(dealId) {
            const noteInput = document.getElementById('new-history-note');
            if (!noteInput.value.trim() || !dealId) return;
            
            const description = noteInput.value.trim();
            await addHistoryEntry(dealId, 'Nota Adicionada', description);
            noteInput.value = '';
        }

        async function addHistoryEntry(dealId, type, description) {
            const historyData = { id_negocio_fk: dealId, tipo_alteracao: type, descricao: description, id_usuario_fk: currentUser.id_usuario };
            const { data, error } = await dbClient.from('sf_historico_negociacao').insert(historyData).select('*, sf_usuarios(nome_usuario)').single();
            if (error) {
                console.error("Erro ao salvar histórico: ", error);
            } else if (!dealModal.classList.contains('hidden')) {
                appData.history.unshift(data);
                renderHistory(dealId);
            }
        }

        // --- NOVAS FUNÇÕES: EDITOR DE MENSAGENS ---
        function showMessagesEditor() {
            messageEditorModal.classList.remove('hidden');
            renderMessagesEditor();
        }

        function hideMessagesEditor() {
            messageEditorModal.classList.add('hidden');
        }

        function renderMessagesEditor() {
            const serviceTags = appData.tags.filter(tag => appData.followup_messages.some(m => m.categoria_servico === tag.id_tag));
            
            let html = `<div class="space-y-6">`;
            
            serviceTags.forEach(tag => {
                const messagesForCategory = appData.followup_messages
                    .filter(m => m.categoria_servico === tag.id_tag)
                    .sort((a, b) => a.etapa - b.etapa);
                
                html += `
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                             <span class="w-4 h-4 rounded-full" style="background-color: ${tag.cor};"></span>
                             <h3 class="text-xl font-bold text-gray-800">${tag.nome_tag}</h3>
                        </div>
                        <div class="space-y-2">
                            ${messagesForCategory.map(msg => `
                                <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold">Etapa ${msg.etapa}: ${msg.titulo}</p>
                                        <p class="text-sm text-gray-500">Enviar após ${msg.intervalo_dias} dia(s)</p>
                                    </div>
                                    <button class="edit-message-btn text-gray-500 hover:text-blue-600" data-message-id="${msg.id_mensagem}">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            html += `</div>
                <div class="mt-8 text-center">
                    <button id="add-new-message-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">
                        <i class="fas fa-plus mr-2"></i> Adicionar Nova Mensagem
                    </button>
                </div>
            `;
            messageEditorModalContent.innerHTML = html;
        }

        function showMessageForm(messageId = null) {
            const isEditing = messageId !== null;
            const message = isEditing ? appData.followup_messages.find(m => m.id_mensagem == messageId) : {};

            const tagsOptions = appData.tags.map(tag => `<option value="${tag.id_tag}" ${message.categoria_servico == tag.id_tag ? 'selected' : ''}>${tag.nome_tag}</option>`).join('');

            messageFormContent.innerHTML = `
                <form id="message-form" data-message-id="${messageId || ''}">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-bold">${isEditing ? 'Editar Mensagem' : 'Nova Mensagem'}</h3>
                    </div>
                    <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                        <div>
                            <label class="font-medium">Categoria do Serviço (Tag)</label>
                            <select name="categoria_servico" class="form-input" required>
                                <option value="">Selecione...</option>
                                ${tagsOptions}
                            </select>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="font-medium">Etapa</label>
                                <input name="etapa" type="number" value="${message.etapa || ''}" class="form-input" placeholder="Ex: 1" required>
                            </div>
                             <div>
                                <label class="font-medium">Intervalo (dias após etapa anterior)</label>
                                <input name="intervalo_dias" type="number" value="${message.intervalo_dias || '0'}" class="form-input" placeholder="Ex: 3" required>
                            </div>
                        </div>
                        <div>
                            <label class="font-medium">Título</label>
                            <input name="titulo" value="${message.titulo || ''}" class="form-input" placeholder="Ex: Follow-up Pós-Reunião" required>
                        </div>
                         <div>
                            <label class="font-medium">Corpo da Mensagem</label>
                            <textarea name="corpo_mensagem" class="form-input" rows="5" placeholder="Use [Nome do Cliente] para personalizar.">${message.corpo_mensagem || ''}</textarea>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 flex justify-between items-center">
                        <div>
                         ${isEditing ? `<button type="button" id="delete-message-btn" class="text-red-500 hover:text-red-700 font-semibold">Excluir</button>` : ''}
                        </div>
                        <div class="flex gap-3">
                            <button type="button" id="cancel-message-form-btn" class="px-4 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-full font-semibold">Cancelar</button>
                            <button type="submit" class="px-4 py-2 text-white bg-green-500 hover:bg-green-600 rounded-full font-semibold">Salvar</button>
                        </div>
                    </div>
                </form>
            `;

            messageFormModal.classList.remove('hidden');
            requestAnimationFrame(() => messageFormContent.classList.remove('scale-95', 'opacity-0'));

            document.getElementById('message-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleSaveMessage(messageId);
            });
            document.getElementById('cancel-message-form-btn').addEventListener('click', hideMessageForm);
            if(isEditing) {
                document.getElementById('delete-message-btn').addEventListener('click', () => {
                    hideMessageForm();
                    showDeleteConfirmModal('message', messageId);
                });
            }
        }

        function hideMessageForm() {
            messageFormContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => messageFormModal.classList.add('hidden'), 300);
        }

        async function handleSaveMessage(messageId) {
            const form = document.getElementById('message-form');
            const formData = new FormData(form);
            const rawData = Object.fromEntries(formData.entries());
            
            const messageData = {
                categoria_servico: parseInt(rawData.categoria_servico),
                etapa: parseInt(rawData.etapa),
                intervalo_dias: parseInt(rawData.intervalo_dias),
                titulo: rawData.titulo,
                corpo_mensagem: rawData.corpo_mensagem
            };

            const existingStep = appData.followup_messages.find(m => 
                m.categoria_servico === messageData.categoria_servico && 
                m.etapa === messageData.etapa &&
                m.id_mensagem != messageId
            );

            if (existingStep) {
                showToast(`Erro: A etapa ${messageData.etapa} já existe para esta categoria.`);
                return;
            }

            try {
                if (messageId) { // Editando
                    const { data, error } = await dbClient.from('sf_followup_mensagens').update(messageData).eq('id_mensagem', messageId).select().single();
                    if (error) throw error;
                    // ATUALIZAÇÃO IMEDIATA NO FRONT-END
                    const index = appData.followup_messages.findIndex(m => m.id_mensagem == messageId);
                    if (index > -1) appData.followup_messages[index] = data;
                    showToast("Mensagem atualizada!");
                } else { // Criando
                    // CORREÇÃO: Gera um ID numérico único no lado do cliente
                    const maxId = appData.followup_messages.reduce((max, msg) => msg.id_mensagem > max ? msg.id_mensagem : max, 0);
                    messageData.id_mensagem = maxId + 1;

                    const { data, error } = await dbClient.from('sf_followup_mensagens').insert(messageData).select().single();
                    if (error) throw error;

                    // ATUALIZAÇÃO IMEDIATA NO FRONT-END
                    appData.followup_messages.push(data);
                    showToast("Mensagem criada!");
                }
                hideMessageForm();
                renderMessagesEditor(); // Re-renderiza o editor de mensagens
            } catch (error) {
                showToast("Erro ao salvar mensagem: " + error.message);
                console.error(error);
            }
        }

        async function handleDeleteMessage(messageId) {
            try {
                const { error } = await dbClient.from('sf_followup_mensagens').delete().eq('id_mensagem', messageId);
                if (error) throw error;
                showToast("Mensagem excluída com sucesso.");
            } catch (error) {
                showToast("Erro ao excluir mensagem: " + error.message);
            }
        }

    </script>
</body>
</html>
